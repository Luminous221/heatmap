<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>ä¸Šæµ·æ™¯ç‚¹çƒ­åŠ›å›¾ä¸åˆ†ç±»æ ‡è®°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/loader.js"></script>
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .custom-marker {
            width: 32px;
            height: 32px;
            background-size: cover;
            border-radius: 50%;
        }
        /* å¼¹çª—è‡ªå®šä¹‰æ ·å¼ */
        .amap-info-content {
            padding: 12px !important;
            min-width: 280px;
            border-radius: 8px !important;
        }
        .info-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .info-title {
            font-size: 16px;
            margin: 6px 0;
            color: #333;
        }
        .info-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
            margin: 8px 0;
        }
        .info-weather {
            color: #1890ff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨åœ°å›¾å’Œçƒ­åŠ›å›¾å®ä¾‹
        let map, heatmap;
        
        function initMap() {
            AMapLoader.load({
                key: "22618fee57b96037ee1d10fced0aa5d9",
                version: "2.0",
                plugins: ['AMap.HeatMap', 'AMap.Marker']
            }).then((AMap) => {
                map = new AMap.Map('map', {
                    viewMode: '2D',
                    center: [121.4737, 31.2304],
                    zoom: 12
                });

                // åˆå§‹åŒ–çƒ­åŠ›å›¾
                initHeatmap(AMap);
                
                // åˆå§‹åŒ–åˆ†ç±»æ ‡è®°
                initMarkers(AMap);
                
                // å¯åŠ¨å®šæ—¶åˆ·æ–°
                setInterval(() => refreshHeatmap(AMap), 5000);

            }).catch(e => {
                console.error("åœ°å›¾åŠ è½½å¤±è´¥:", e);
            });
        }

        function initHeatmap(AMap) {
            // çƒ­åŠ›å›¾æ•°æ®
            const heatmapData = generateHeatmapData();
            
            // åˆ›å»ºçƒ­åŠ›å›¾
            heatmap = new AMap.HeatMap(map, {
                radius: 40,
                opacity: [0.6, 0.8],
                gradient: {
                    0.4: 'blue',
                    0.6: 'cyan',
                    0.7: 'lime',
                    0.8: 'yellow',
                    1.0: 'red'
                },
                zooms: [3, 18]
            });
            
            heatmap.setDataSet({
                data: heatmapData,
                max: 100
            });
        }

        function initMarkers(AMap) {
            const icons = {
                'åœ°æ ‡æ™¯ç‚¹': 'https://cdn-icons-png.flaticon.com/128/18499/18499155.png',
                'å•†ä¸šä¼‘é—²': 'https://cdn-icons-png.flaticon.com/128/11030/11030893.png',
                'æ–‡åŒ–å†å²': 'https://cdn-icons-png.flaticon.com/128/2346/2346307.png',
                'å…¬å…±ç©ºé—´': 'https://cdn-icons-png.flaticon.com/128/2169/2169407.png',
            };

            const locations = [
                { name: "å¤–æ»©", lat: 31.2415, lng: 121.4904, type: "åœ°æ ‡æ™¯ç‚¹",
                desc: "ä¸Šæµ·æœ€å…·ä»£è¡¨æ€§çš„æ»¨æ±Ÿæ™¯è§‚å¸¦ï¼Œ52å¹¢é£æ ¼è¿¥å¼‚çš„å†å²å»ºç­‘ç¾¤ï¼Œè¢«èª‰ä¸º'ä¸‡å›½å»ºç­‘åšè§ˆ'ã€‚"},
                { name: "å—äº¬è·¯æ­¥è¡Œè¡—", lat: 31.2356, lng: 121.4752, type: "å•†ä¸šä¼‘é—²",
                desc: "ä¸­å›½ç¬¬ä¸€æ¡å•†ä¸šæ­¥è¡Œè¡—ï¼Œé›†è´­ç‰©ã€é¤é¥®ã€å¨±ä¹äºä¸€ä½“ï¼Œç´ æœ‰'ä¸­åå•†ä¸šç¬¬ä¸€è¡—'ç¾èª‰ã€‚"},
                { name: "è±«å›­", lat: 31.2279, lng: 121.4873, type: "æ–‡åŒ–å†å²" },
                { name: "ä¸Šæµ·åšç‰©é¦†", lat: 31.2304, lng: 121.4737, type: "æ–‡åŒ–å†å²" },
                { name: "äººæ°‘å¹¿åœº", lat: 31.2328, lng: 121.4761, type: "å…¬å…±ç©ºé—´" },
                { name: "ä¸Šæµ·å¤§å‰§é™¢", lat: 31.2319, lng: 121.4756, type: "æ–‡åŒ–å†å²" },
                { name: "ç”°å­åŠ", lat: 31.2076, lng: 121.4692, type: "å•†ä¸šä¼‘é—²" },
                { name: "æ–°å¤©åœ°", lat: 31.2186, lng: 121.4758, type: "å•†ä¸šä¼‘é—²" },
                { name: "å¤–ç™½æ¸¡æ¡¥", lat: 31.2442, lng: 121.4911, type: "åœ°æ ‡æ™¯ç‚¹" },
                { name: "ä¸Šæµ·åŸå¸‚è§„åˆ’é¦†", lat: 31.2341, lng: 121.4742, type: "åœ°æ ‡æ™¯ç‚¹" },
                { name: "äº‘å—å—è·¯ç¾é£Ÿè¡—", lat: 31.2225, lng: 121.4793, type: "å•†ä¸šä¼‘é—²" },
                { name: "æ€å—å…¬é¦†", lat: 31.2143, lng: 121.4708, type: "æ–‡åŒ–å†å²" },
                { name: "é™å®‰å¯º", lat: 31.2231, lng: 121.4465, type: "åœ°æ ‡æ™¯ç‚¹" },
                { name: "å—äº¬è¥¿è·¯å•†åœˆ", lat: 31.2309, lng: 121.4598, type: "å•†ä¸šä¼‘é—²" },
                { name: "å…´ä¸šå¤ªå¤æ±‡", lat: 31.2287, lng: 121.4602, type: "å•†ä¸šä¼‘é—²" },
                { name: "å¼ å›­", lat: 31.2254, lng: 121.4546, type: "æ–‡åŒ–å†å²" },
                { name: "é©¬å‹’åˆ«å¢…", lat: 31.2332, lng: 121.4519, type: "æ–‡åŒ–å†å²" },
                { name: "é™å®‰é›•å¡‘å…¬å›­", lat: 31.2278, lng: 121.4501, type: "å…¬å…±ç©ºé—´" },
                { name: "å¤§æ‚¦åŸ", lat: 31.2396, lng: 121.4483, type: "å•†ä¸šä¼‘é—²" },
                { name: "å´æ±Ÿè·¯æ­¥è¡Œè¡—", lat: 31.2315, lng: 121.4624, type: "å•†ä¸šä¼‘é—²" },
                { name: "ä¸Šæµ·è‡ªç„¶åšç‰©é¦†", lat: 31.2375, lng: 121.4583, type: "åœ°æ ‡æ™¯ç‚¹" },
                { name: "å¾å®¶æ±‡å•†åœˆ", lat: 31.1956, lng: 121.4380, type: "å•†ä¸šä¼‘é—²" },
                { name: "ä¸Šæµ·å›¾ä¹¦é¦†", lat: 31.2098, lng: 121.4412, type: "å…¬å…±ç©ºé—´" },
                { name: "é¾™åå¯º", lat: 31.1729, lng: 121.4493, type: "åœ°æ ‡æ™¯ç‚¹" },
                { name: "æ­¦åº·è·¯å†å²æ–‡åŒ–è¡—", lat: 31.2012, lng: 121.4328, type: "æ–‡åŒ–å†å²" },
                { name: "ä¸Šæµ·ä½“è‚²é¦†", lat: 31.1853, lng: 121.4376, type: "å…¬å…±ç©ºé—´" },
                { name: "å¾æ±‡æ»¨æ±Ÿ", lat: 31.1894, lng: 121.4578, type: "å…¬å…±ç©ºé—´" },
                { name: "è¡¡å±±è·¯é…’å§è¡—", lat: 31.2045, lng: 121.4467, type: "å•†ä¸šä¼‘é—²" },
                { name: "ä¸Šæµ·ç”µå½±åšç‰©é¦†", lat: 31.2087, lng: 121.4389, type: "åœ°æ ‡æ™¯ç‚¹" },
                { name: "å…‰å¯å…¬å›­", lat: 31.1978, lng: 121.4315, type: "å…¬å…±ç©ºé—´" }
            ];

            locations.forEach(loc => {
                const iconUrl = icons[loc.type] || icons["åœ°æ ‡æ™¯ç‚¹"];
                const content = `<div class="custom-marker" style="background-image: url('${iconUrl}')"></div>`;
                const marker = new AMap.Marker({
                    position: [loc.lng, loc.lat],
                    content: content,
                    anchor: 'bottom-center',
                    title: loc.name,
                });
                marker.setMap(map);
                marker.on('click', () => {
                    AMap.Popup && AMap.Popup.closeAll();
                    
                    // ç”Ÿæˆå¤©æ°”ä¿¡æ¯
                    const weatherData = generateWeather();
                    
                    // ç”Ÿæˆæ¸¸ç©æ—¶é—´
                    const playTime = generatePlayTime();
                    
                    // æ„å»ºå¼¹çª—å†…å®¹
                    const popupContent = `
                        <img src="${loc.photo}" class="info-image" 
                             onerror="this.src='https://dummyimage.com/280x160/eee/999'">
                        <div class="info-title">${loc.name}</div>
                        <div>ç±»å‹ï¼š${loc.type}</div>
                        <div class="info-desc">${loc.desc}</div>
                        <div class="info-weather">
                            ${weatherData.icon} ${weatherData.text} | æ¸©åº¦ï¼š${weatherData.temp}â„ƒ
                        </div>
                        <div>é¢„è®¡æ¸¸ç©ï¼š${playTime}</div>
                    `;

                    const popup = new AMap.InfoWindow({
                        content: popupContent,
                        offset: new AMap.Pixel(0, -30),
                        closeWhenClickMap: true
                    });
                    popup.open(map, [loc.lng, loc.lat]);
                });
            });
        }
        // ç”Ÿæˆå¤©æ°”ä¿¡æ¯
        function generateWeather() {
            const weatherList = [
                { icon: "â˜€ï¸", text: "æ™´å¤©ï¼ˆå»ºè®®é˜²æ™’ï¼‰", min: 20, max: 30 },
                { icon: "â›…", text: "å¤šäº‘ï¼ˆé€‚å®œå‡ºè¡Œï¼‰", min: 18, max: 28 },
                { icon: "ğŸŒ§ï¸", text: "å°é›¨ï¼ˆè®°å¾—å¸¦ä¼ï¼‰", min: 15, max: 25 },
                { icon: "ğŸŒ¤ï¸", text: "æ™´è½¬å¤šäº‘", min: 19, max: 27 }
            ];
            const weather = weatherList[Math.floor(Math.random() * weatherList.length)];
            return {
                icon: weather.icon,
                text: weather.text,
                temp: (Math.random() * (weather.max - weather.min) + weather.min).toFixed(1)
            };
        }

        // ç”Ÿæˆæ¸¸ç©æ—¶é—´
        function generatePlayTime() {
            const minutesOptions = [30, 45, 60, 90, 120, 150, 180];
            const minutes = minutesOptions[Math.floor(Math.random() * minutesOptions.length)];
            return minutes < 60 ? 
                `${minutes}åˆ†é’Ÿ` : 
                `${Math.floor(minutes/60)}å°æ—¶${minutes%60 ? `${minutes%60}åˆ†é’Ÿ` : ''}`;
        }
        
        function generateHeatmapData() {
            // è¿™é‡Œå¯ä»¥æ¨¡æ‹Ÿæ•°æ®å˜åŒ–ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ä»æœåŠ¡å™¨è·å–æ–°æ•°æ®
            return [
               { name: "å¤–æ»©", lng: 121.4904, lat: 31.2415, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "å—äº¬è·¯æ­¥è¡Œè¡—", lng: 121.4752, lat: 31.2356, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "è±«å›­", lng: 121.4873, lat: 31.2279, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "ä¸Šæµ·åšç‰©é¦†", lng: 121.4737, lat: 31.2304, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "äººæ°‘å¹¿åœº", lng: 121.4761, lat: 31.2328, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "ä¸Šæµ·å¤§å‰§é™¢", lng: 121.4756, lat: 31.2319, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "ç”°å­åŠ", lng: 121.4692, lat: 31.2076, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "æ–°å¤©åœ°", lng: 121.4758, lat: 31.2186, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "å¤–ç™½æ¸¡æ¡¥", lng: 121.4911, lat: 31.2442, value: Math.min(100, Math.floor(Math.random() * 75)) },
    { name: "ä¸Šæµ·åŸå¸‚è§„åˆ’é¦†", lng: 121.4742, lat: 31.2341, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "äº‘å—å—è·¯ç¾é£Ÿè¡—", lng: 121.4793, lat: 31.2225, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "æ€å—å…¬é¦†", lng: 121.4708, lat: 31.2143, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "é™å®‰å¯º", lng: 121.4465, lat: 31.2231, value: Math.min(100, Math.floor(Math.random() * 115)) },
    { name: "å—äº¬è¥¿è·¯å•†åœˆ", lng: 121.4598, lat: 31.2309, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "å…´ä¸šå¤ªå¤æ±‡", lng: 121.4602, lat: 31.2287, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "å¼ å›­", lng: 121.4546, lat: 31.2254, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "é©¬å‹’åˆ«å¢…", lng: 121.4519, lat: 31.2332, value: Math.min(100, Math.floor(Math.random() * 100)) },
    { name: "é™å®‰é›•å¡‘å…¬å›­", lng: 121.4501, lat: 31.2278, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "å¤§æ‚¦åŸ", lng: 121.4483, lat: 31.2396, value: Math.min(100, Math.floor(Math.random() * 85)) },
    { name: "å´æ±Ÿè·¯æ­¥è¡Œè¡—", lng: 121.4624, lat: 31.2315, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "ä¸Šæµ·è‡ªç„¶åšç‰©é¦†", lng: 121.4583, lat: 31.2375, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "å¾å®¶æ±‡å•†åœˆ", lng: 121.4380, lat: 31.1956, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "ä¸Šæµ·å›¾ä¹¦é¦†", lng: 121.4412, lat: 31.2098, value: Math.min(100, Math.floor(Math.random() * 110)) },
    { name: "é¾™åå¯º", lng: 121.4493, lat: 31.1729, value: Math.min(100, Math.floor(Math.random() * 75)) },
    { name: "æ­¦åº·è·¯å†å²æ–‡åŒ–è¡—", lng: 121.4328, lat: 31.2012, value: Math.min(100, Math.floor(Math.random() * 110)) },
    { name: "ä¸Šæµ·ä½“è‚²é¦†", lng: 121.4376, lat: 31.1853, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "å¾æ±‡æ»¨æ±Ÿ", lng: 121.4578, lat: 31.1894, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "è¡¡å±±è·¯é…’å§è¡—", lng: 121.4467, lat: 31.2045, value: Math.min(100, Math.floor(Math.random() * 120)) },
    { name: "ä¸Šæµ·ç”µå½±åšç‰©é¦†", lng: 121.4389, lat: 31.2087, value: Math.min(100, Math.floor(Math.random() * 100)) },
    { name: "å…‰å¯å…¬å›­", lng: 121.4315, lat: 31.1978, value: Math.min(100, Math.floor(Math.random() * 100)) }
            ].map(item => ({
                lng: item.lng,
                lat: item.lat,
                count: item.value
            }));
        }

        function refreshHeatmap(AMap) {
            // ç”Ÿæˆæ–°çš„çƒ­åŠ›å›¾æ•°æ®
            const newData = generateHeatmapData();
            
            // æ›´æ–°çƒ­åŠ›å›¾
            heatmap.setDataSet({
                data: newData,
                max: 100
            });
            
            console.log("çƒ­åŠ›å›¾æ•°æ®å·²åˆ·æ–°", new Date());
        }

        // åˆå§‹åŒ–åœ°å›¾
        initMap();
    </script>
</body>
</html>
